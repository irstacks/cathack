<html>
  <head>
    <title>CatChat</title>
  </head>

  <!-- bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- octicons? -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css">

  <!-- jquery -->
  <script   src="https://code.jquery.com/jquery-3.0.0.min.js"   integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0="   crossorigin="anonymous"></script>

  <!-- momentjs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>

  <!-- light markdown -->
 <!--  <script src="https://cdn.rawgit.com/Tonkean/lightMarkdown/0.1.2/dist/light-markdown.min.js"></script> -->
 
 <!-- highlightjs   -->
 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css">
 <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>

  <style>
    body {
      background-color: black;
    }
    pre {
      border: none;
    }
    #chat {
      text-align: left;
      background: black;
      color: lightgreen;
      width: 100%;
      padding: 20px;
      
      /*autoscrolalble*/
      height: 80vh;
      overflow: auto;
      display: block;
      font-family: monospace;
      /*white-space: pre;*/
      margin: 1em 0;

    }
    p {
      margin: 0;
      line-height: 1.8rem;
      -webkit-margin-before: 0em;
      -webkit-margin-after: 0.3rem;
      -webkit-margin-start: 0px;
      -webkit-margin-end: 0px;
    }
/*    .row:before {
      content: none;
      display: none;
    }
    .row:after {
      display: none;
    }
    .col-sm-4:before, .col-sm-4:after {
      display: none;
    }
    .col-sm-8:before, .col-sm-8:after {
      display: none;
    }*/
 /*   .row {
      margin: 0 -15 0 15px;
      padding: 0;
    }
    .col-sm-3, .col-sm-9 {
     margin: 0 -15 0 15px;
     padding: 0; 
    }*/
    pre {
      display: block;
      padding: 1rem;
      margin: 2 0 6 0rem;
      /*font-size: 1rem;*/
      /*line-height: 1.4rem;*/
      word-break: break-all;
      word-wrap: break-word;
      border-radius: 2px;
    }
    .input-holder {
      position: fixed;
      bottom: 0;
      width: 95%;
    }
    textarea#text {
      background: black;
      border: none;
      color: lightgreen;
      width: 100%;
    }
    #open-chatty-full {
      position: fixed;
      top: 0;
      right: 0;
      padding: 3vh;
      z-index: 10;
    }
    span.rot {
      color: #00BFFF;
    }
    span.blau {
      color: red;
    }

    /*bs tweakers*/
    .form-control:focus {
      border: none;
      box-shadow: none;
    }
  </style>

  <iframe id="frmFile" src="chat.txt" onload="LoadFile();" style="display: none" ></iframe>

  <body>

    <div class="container-fluid">
      <div class="row">
  
        <a id="open-chatty-full" class="text-primary" target="_blank" href="http://www.chat.areteh.co:5000"><span class="glyphicon glyphicon-resize-full"></span></a>

        <div class="col-sm-12">

          <div id="chat"></div> 

          <div class="input-holder" >
            <div class="form-group">
              <label for="">
                <span id="other-is-typing" style="display: none;"><small>Somebody else is typing...</small></span>
              </label>
              <textarea class="form-control" placeholder="$ echo" row="3" id="text" type="text"></textarea>
            </div>  
          </div>
          
        </div>
        
      </div>
    </div>

    <script type="text/javascript" >
      
        var chat = document.getElementById("chat");
        var url = "ws://" + window.location.host + "/ws";
        var ws = new WebSocket(url);
        var chat = document.getElementById("chat");
        var text = $("#text");
        var isTypingDisplay = $("#other-is-typing");
        var data = [];
        
        function formatDate(goTimeString) {
          
          if (goTimeString) {
            var cleanString = goTimeString.replace(' UTC', '');
            var a = moment.utc(cleanString);
            var b = a.local().format(" kk:mm:ss ddd DMMM");
            
            if (a.isValid()) {
              return b;  
            } else {
              return goTimeString;
            }  
          } else {
            return "";
          }
        }
        
        function emphasizeHTML(string) {
          return '<em>' + string + '</em>';
        }
        function smallifyHTML(string) {
          return '<small>' + string + '</small>';
        }
        function strongifyHTML(string) {
          return '<strong>' + string + '</strong>'; 
        }
        function classifyString(string, classs) {
          return '<span class="' + classs + '">' + string + '</span>';  
        }
        
        function formatPS1(line) {
      
          var ps = "";
          var d = JSON.parse(line);

          // ps += formatDate(d["Time"]);
          // ps += " @ " + strongifyHTML(d["City"]) + " $ ";
          // var position = d["Message"].indexOf(">") + 1; // <p>
          // var out = [d["Message"].slice(0,position), ps, d["Message"].slice(position)].join(''); 
          
          // // return lightMarkdown.toHtml(out);
          // return out;
          var out = "<div class='row'>";

          var ps = "<div class='col-xs-4'>";
          ps += "<p>";
          ps += "<span class='hidden-xs'>" + formatDate(d["Time"]) + " @ " + "</span>";
          ps += strongifyHTML(d["City"]) + " $ ";
          ps += "</p></div>";

          var says = "<div class='col-xs-8'>";
          says += d["Message"];
          says += "</div>";

          out += ps + says;
          out += "</div>";
          return out;
        }

        // function formatStatus(jsonLine) {
        //   var d = JSON.parse(jsonLine);
        //   return "\> " + classifyString(d["status"], 'label label-primary')
        // }

        // http://stackoverflow.com/questions/10191941/jquery-unique-on-an-array-of-strings
        // function unique(array) {
        //   return array.filter(function(el, index, arr) {
        //         return index === arr.indexOf(el);
        //     });
        // }
        
        function renderData(data) {

          html = "";

          jQuery.each(data, function () {
            // console.log(this);
            html += formatPS1(this);  
          });

          chat.innerHTML = html;

          $('pre').each(function(i, block) {
              hljs.highlightBlock(block);
            });
        }
        function showOtherIsTyping() {
          isTypingDisplay.show();
        }
        function hideOtherIsTyping() {
          isTypingDisplay.hide();
        }
        
        function scrollChat() {
          var div = $('#chat');
          div.scrollTop(div.prop('scrollHeight'));
        }
        
        //Seems like this might not be the way to handle loadin up a text file
        function LoadFile() {
            var oFrame = document.getElementById("frmFile");
        
            var strRawContents = oFrame.contentWindow.document.body.childNodes[0].innerHTML;

            var arrLines = strRawContents.split("\n");
            for (var i = 0; i < arrLines.length - 1; i++) {
                var curLine = arrLines[i];
                
                data.push(curLine);
            }

            renderData(data);
        }
        
        ws.onmessage = function (msg) {

          console.log(JSON.stringify(msg));

          var line = msg.data;

          // If the message is not about another person typing. 
          if (msg.data !== "***" && msg.data !== "!***") {
            hideOtherIsTyping();
            data.push(line);
            renderData(data);  
            scrollChat(); // set to bottom nicelike

          // If another person is typing. 
          } else if (msg.data === "***") {
            // other is typing
            showOtherIsTyping();

          // Another person is not typing anymore.
          } else if (msg.data === "!***") {
            hideOtherIsTyping();
          }
        };

        $('.form-group').on('input', '#text', function () {
          // console.log("I inputted! Value: " + $("#text").val());
          var v = $('#text').val();
          if (v !== "") {
            ws.send('***');
          } else {
            ws.send("!***");
          }
        });

        text.keyup(function (e) {
          if (!e.shiftKey && e.which == 13 && $.trim(text.val()).length > 0) {
            console.log('Sending value ->' + text.val());
            // this should be redundant since js will re-render all data
            // ws.send("!***") 
            ws.send(text.val()); 
            
            text.val(''); 
          }
        })

        // text.on('key') = function (e) {
        //   // // If pushed a button that wasn't enter.
        //   // if (e.keyCode !== 13) { 

        //   //   var typing = $('#text').val();

        //   //   //  and there is text in the field.
        //   //   if (typing !== "") { // (use new identifier for text field)
        //   //     console.log('Sending ***');
        //   //     console.log('typing = ' + typing);
        //   //     ws.send('***');  
            
        //   //   } 

        //   //   if (typing === "") {
        //   //     //remove is typing display
        //   //     console.log("Sending !***");
        //   //     ws.send('!***');
        //   //   }
        //   // }

        //   // If pushed return and field is not blank.
        //   if (e.keyCode === 13 && text.val() !== "") {
         
        //       console.log('Sending value ->' + text.value);
        //       // this should be redundant since js will re-render all data
        //       // ws.send("!***") 
        //       ws.send(text.value); 
        //       $("#text").empty();
        //       // $("#text").val(''); 
            
        //   }
        // };
        
        // scroll to bottom on doc ready
        $(function () {
          scrollChat();

        });

    </script>
    
    

  </body>
</html>
