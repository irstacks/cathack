<html>
  <head>
    <title>CatChat</title>
  </head>

  <!-- bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- octicons? -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css">

  <!-- jquery -->
  <script   src="https://code.jquery.com/jquery-3.0.0.min.js"   integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0="   crossorigin="anonymous"></script>

  <!-- momentjs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>
 
  <style>
    body {
      background-color: black;
    }
    pre {
      border: none;
    }
    #chat {
      text-align: left;
      background: black;
      color: lightgreen;
      width: 100%;
      padding: 20px;
      
      /*autoscrolalble*/
      height: 80vh;
      overflow: auto;
    }
    .input-holder {
      position: fixed;
      bottom: 0;
      width: 95%;
    }
    input#text {
      background: black;
      border: none;
      color: lightgreen;
    }
    #open-chatty-full {
      position: fixed;
      top: 0;
      right: 0;
      padding: 3vh;
      z-index: 10;
    }
    span.rot {
      color: #00BFFF;
    }
    span.blau {
      color: red;
    }

    /*bs tweakers*/
    .form-control:focus {
      border: none;
      box-shadow: none;
    }
  </style>

  <iframe id="frmFile" src="chat.txt" onload="LoadFile();" style="display: none" ></iframe>

  <body>

    <div class="container-fluid">
      <div class="row">
  
        <a id="open-chatty-full" class="text-primary" target="_blank" href="http://www.chat.areteh.co:5000"><span class="glyphicon glyphicon-resize-full"></span></a>

        <div class="col-sm-12">

          <pre id="chat"></pre> 

          <div class="input-holder" >
            <div class="form-group">
              <input class="form-control" placeholder="$ echo" id="text" type="text">  
            </div>  
          </div>
          
        </div>
        
      </div>
    </div>

    <script type="text/javascript" >
      
        var chat = document.getElementById("chat");
        var url = "ws://" + window.location.host + "/ws";
        var ws = new WebSocket(url);
        var chat = document.getElementById("chat");
        var text = document.getElementById("text");
        var data = [];
        
        function formatDate(goTimeString) {
        
          var cleanString = goTimeString.replace(' UTC', '');
          var a = moment.utc(cleanString);
          var b = a.local().format(" kk:mm:ss ddd DMMM");
        
          if (a.isValid()) {
            return b;  
          } else {
            return goTimeString
          }
        }
        
        function emphasizeHTML(string) {
          return '<em>' + string + '</em>';
        }
        function smallifyHTML(string) {
          return '<small>' + string + '</small>';
        }
        function strongifyHTML(string) {
          return '<strong>' + string + '</strong>'; 
        }
        function classifyString(string, classs) {
          return '<span class="' + classs + '">' + string + '</span>';  
        }
        
        function formatPS1(jsonLine) {
        
          var d = JSON.parse(jsonLine);
          var out = "";
        
          out += formatDate(d["time"]);
          out += " @ " + strongifyHTML(d["city"]);
          out += " $ " + d["message"], d["city"];
        
          return out;
        }
        function formatStatus(jsonLine) {
          var d = JSON.parse(jsonLine);
          return "\> " + classifyString(d["status"], 'label label-primary')
        }
        // http://stackoverflow.com/questions/10191941/jquery-unique-on-an-array-of-strings
        // function unique(array) {
        //   return array.filter(function(el, index, arr) {
        //         return index === arr.indexOf(el);
        //     });
        // }
        
        function renderData(data) {
          html = "";
          jQuery.each(data, function () {
            if (JSON.parse(this)["status"]) {
              html += formatStatus(this) + "\n";
            } else {
              html += formatPS1(this) + "\n";  
            }
          });
          chat.innerHTML = html;
        }
        
        // function colorizeChat() {
        
        // }
        
        // function appendData(line) {
        //   chat.innerHTML += formatPS1(this) + "\n";
        // }
        
        function scrollChat() {
          var div = $('#chat');
          div.scrollTop(div.prop('scrollHeight'));
        }
        
        //Seems like this might not be the way to handle loadin up a text file
        function LoadFile() {
            var oFrame = document.getElementById("frmFile");
        
            var strRawContents = oFrame.contentWindow.document.body.childNodes[0].innerHTML;
            var arrLines = strRawContents.split("\n");
            for (var i = 0; i < arrLines.length - 1; i++) {
                var curLine = arrLines[i];
                data.push(curLine);
                // chat.innerText += handleLineFormatting(curLine) + "\n";
                // chat.innerHTML += handleLineFormatting(curLine) + "\n";
            }
            renderData(data);
        }
        
        ws.onmessage = function (msg) {
          var line = msg.data;
        
          // handle line formatting
          // chat.innerText += handleLineFormatting(line) + "\n";
          // chat.innerHTML += handleLineFormatting(line) + "\n";
          data.push(line);
          renderData(data);
        
          scrollChat(); // set to bottom nicelike
        };
        text.onkeydown = function (e) {
          if (e.keyCode === 13 && text.value !== "") {

            ws.send(text.value); 
            text.value = "";
          }
        };
        
        // scroll to bottom on doc ready
        $(function () {
          scrollChat();
        });

    </script>
    

  </body>
</html>
