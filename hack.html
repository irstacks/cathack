<html>
  <head>
    <title>HackChat</title>
  </head>

  <!-- bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <!-- octicons? -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css">

  <!-- jquery -->
  <script   src="https://code.jquery.com/jquery-3.0.0.min.js"   integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0="   crossorigin="anonymous"></script>

  <!-- codemirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/codemirror.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/codemirror.min.css">
    <!-- go  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/mode/go/go.min.js"></script>
    <!-- js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.16.0/mode/javascript/javascript.min.js"></script>

  <style>
    
  </style>

  <body>

    <div class="container-fluid">
      <h1 style="color: #BEE0FC;">/hack <i class="octicon octicon-octocat"></i></h1>

      <div class="row">
        <div class="col-md-3">
          <select name="" id="mode-picker">
            <option value="javascript" selected="selected">JS</option>
            <option value="go">Go</option>
          </select>
        </div>

        <div class="col-md-9">
          <div id="editor"></div>
        </div>
      </div>
      

    </div>

    <script>
      
      var url = "ws://" + window.location.host + "/hack/ws";
      var ws = new WebSocket(url);
      var editor = $("#editor");
      var modePicker = $("#mode-picker");

      var cm = CodeMirror(editor[0], {
        mode:  "javascript",
        lineNumbers: true,
        tabSize: 2
      });

      // get val
      ws.onmessage = function (msg) {
        var d = msg.data;
        console.log("received onmessage -> " + JSON.stringify(d));
        var j = JSON.parse(d);

        modePicker.val(j.language);
        cm.setOption("mode", j.language);
        cm.setValue(j.content);
      };

      function sendUpdate() {
        var lang = $('#mode-picker').val();
        var t = cm.getValue();
        var s = JSON.stringify({language: lang, content: t});
        ws.send(s);
      }

      // send updates 
      // on key up
      editor.keyup(function (e) {
        sendUpdate();
      });
      // on mode picking
      modePicker.on("change", function () {
        cm.setOption("mode", $(this).val());
        sendUpdate();
      });

    </script>
    

  </body>
</html>
